# üîí –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ VK Mini App

## –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π.

## üõ°Ô∏è –£—Ä–æ–≤–Ω–∏ –∑–∞—â–∏—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ VK –ø–æ–¥–ø–∏—Å–∏ (VK Launch Params Signature)

**–ß—Ç–æ —ç—Ç–æ:** VK –ø–µ—Ä–µ–¥–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞ (vk_user_id, vk_app_id –∏ –¥—Ä.) –≤–º–µ—Å—Ç–µ —Å HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å—é, –∫–æ—Ç–æ—Ä–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –±—ã–ª–∏ –ø–æ–¥–¥–µ–ª–∞–Ω—ã.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ `VKWebAppGetLaunchParams` –æ—Ç VK Bridge
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∫–ª—é—á–∞—é—Ç `sign` - HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å
- Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –∏—Å–ø–æ–ª—å–∑—É—è `VK_APP_SECRET`
- –¢–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å—ã —Å –≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

**–ó–∞—â–∏—â–µ–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:**
- `/api/subscribe/` - –ø–æ–¥–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/api/subscribe/allow-messages/` - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `/api/unsubscribe/` - –æ—Ç–ø–∏—Å–∫–∞
- `/api/subscription/status/` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- **Backend:** `backend/app/vk_security.py` - —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏
- **Backend:** `backend/config/vk_middleware.py` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- **Frontend:** `frontend/src/hooks/useLaunchParams.ts` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å –ø–æ–¥–ø–∏—Å—å—é

### 2. Rate Limiting (–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤)

**–ß—Ç–æ —ç—Ç–æ:** –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–¥–Ω–æ–≥–æ IP –∞–¥—Ä–µ—Å–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç DDoS –∏ —Å–ø–∞–º–∞.

**–õ–∏–º–∏—Ç—ã:**
- `/api/config/` - 60 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- `/api/offers/` - 100 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- `/api/subscribe/` - 20 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- `/api/subscribe/allow-messages/` - 20 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- `/api/unsubscribe/` - 10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- `/api/subscription/status/` - 30 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `django-ratelimit` —Å –∫–ª—é—á–æ–º –ø–æ IP –∞–¥—Ä–µ—Å—É

### 3. CORS (Cross-Origin Resource Sharing)

**–ß—Ç–æ —ç—Ç–æ:** –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ–º–µ–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ API.

**Production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```python
CORS_ALLOWED_ORIGINS = [
    'https://vk.com',
]
CORS_ALLOW_CREDENTIALS = True
```

–¢–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ VK –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –Ω–∞ production.

### 4. HTTPS —Å SSL

**–ß—Ç–æ —ç—Ç–æ:** –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —Å–µ—Ä–≤–µ—Ä–æ–º.

**Production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ HTTPS (–ø–æ—Ä—Ç 443)
- HTTP –∑–∞–ø—Ä–æ—Å—ã —Ä–µ–¥–∏—Ä–µ–∫—Ç—è—Ç—Å—è –Ω–∞ HTTPS
- SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è Let's Encrypt)

### 5. Security Headers

**Django security settings (production):**
```python
SECURE_SSL_REDIRECT = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
SECURE_HSTS_SECONDS = 31536000
```

### 6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:**
- –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏
- IP –∞–¥—Ä–µ—Å–∞ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –∞—Ç–∞–∫

**–ì–¥–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏:**
```bash
docker-compose -f docker-compose.prod.yml logs backend | grep "VK signature"
```

## üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (production.env)

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ:**
```env
# –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á VK –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏)
VK_APP_SECRET=your-vk-app-secret-key

# –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á Django
DJANGO_SECRET_KEY=your-very-secure-secret-key-CHANGE-THIS

# –ü–∞—Ä–æ–ª—å PostgreSQL
POSTGRES_PASSWORD=change-this-secure-password
```

‚ö†Ô∏è **–ù–ò–ö–û–ì–î–ê –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ production.env –≤ git!**

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ VPS

1. **Firewall (UFW):**
```bash
sudo ufw allow 443/tcp
sudo ufw allow 80/tcp
sudo ufw enable
```

2. **Fail2Ban (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã):**
```bash
sudo apt install fail2ban
sudo systemctl enable fail2ban
```

3. **SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (Let's Encrypt):**
```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ VK –ø–æ–¥–ø–∏—Å–∏

**–¢–µ—Å—Ç –ª–æ–∫–∞–ª—å–Ω–æ:**
```python
# backend/app/vk_security.py
from app.vk_security import verify_vk_launch_params

params = {
    'vk_user_id': '12345',
    'vk_app_id': '51888888',
    'vk_platform': 'mobile_web',
    'sign': 'calculated_sign_here'
}

is_valid = verify_vk_launch_params(params)
print(f"Signature valid: {is_valid}")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limiting

```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å 30 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Å–µ–∫—É–Ω–¥—É (–¥–æ–ª–∂–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è)
for i in {1..30}; do
  curl https://your-domain.com/api/config/ &
done
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ CORS

```bash
# –ó–∞–ø—Ä–æ—Å —Å –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ (–¥–æ–ª–∂–µ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è)
curl -H "Origin: https://evil.com" \
     https://your-domain.com/api/config/
```

## üö® –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –∞—Ç–∞–∫–µ

### 1. DDoS –∞—Ç–∞–∫–∞

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
- High CPU/Memory usage

**–î–µ–π—Å—Ç–≤–∏—è:**
```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–ø IP –∞–¥—Ä–µ—Å–æ–≤
docker-compose -f docker-compose.prod.yml logs nginx | \
  awk '{print $1}' | sort | uniq -c | sort -rn | head -20

# –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å IP –≤ nginx
# –î–æ–±–∞–≤–∏—Ç—å –≤ nginx/prod.conf:
# deny 123.456.789.0;
```

### 2. –ü–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–¥–µ–ª–∫–∏ VK –ø–æ–¥–ø–∏—Å–∏

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
```bash
# –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç failed signature
docker-compose -f docker-compose.prod.yml logs backend | \
  grep "VK signature validation failed"
```

**–î–µ–π—Å—Ç–≤–∏—è:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `VK_APP_SECRET` –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
- –ó–∞–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –∞—Ç–∞–∫—É—é—â–∏–µ IP —á–µ—Ä–µ–∑ firewall

### 3. –ë—Ä—É—Ç—Ñ–æ—Ä—Å –∞–¥–º–∏–Ω–∫–∏

**–î–µ–π—Å—Ç–≤–∏—è:**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å fail2ban —Ñ–∏–ª—å—Ç—Ä –¥–ª—è Django admin
# –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å django-axes –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
```

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Production

- [ ] `VK_APP_SECRET` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] `DJANGO_SECRET_KEY` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á
- [ ] `POSTGRES_PASSWORD` - —Å–ª–æ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å
- [ ] `DEBUG=False` –≤ production
- [ ] HTTPS –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –≤–∞–ª–∏–¥–Ω—ã–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º
- [ ] Firewall (UFW) –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è VK
- [ ] `production.env` –ù–ï –≤ git (–≤ .gitignore)
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- [ ] –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –±—ç–∫–∞–ø—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç (uptime, errors)

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [VK Mini Apps Security](https://dev.vk.com/ru/mini-apps/development/launch-params)
- [Django Security](https://docs.djangoproject.com/en/4.2/topics/security/)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)

## üêõ –°–æ–æ–±—â–∏—Ç—å –æ —É—è–∑–≤–∏–º–æ—Å—Ç–∏

–ï—Å–ª–∏ –≤—ã –Ω–∞—à–ª–∏ —É—è–∑–≤–∏–º–æ—Å—Ç—å –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, **–ù–ï —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π issue**. 

–°–≤—è–∂–∏—Ç–µ—Å—å —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ –Ω–∞–ø—Ä—è–º—É—é.

